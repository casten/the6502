<html>
<head>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" 
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" 
            crossorigin="anonymous"></script>
  <script lang="text/javascript" src="https://unpkg.com/simple-web-serial@latest/dist/simple-web-serial.min.js"></script>

<link rel="icon" href="/img/domain/favicon.ico" sizes="32x32">
<link rel="icon" href="/img/icon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

<script>

var swsConnection = null;
var followOutput = true;
var hz = 10;
var  computedStyle = null;
var  lineHeight = null;
var lineCounts = {};
var notifiedLogTruncation = false;

function add_text(id, text, end="\n") {
  const textCtl = $("#"+id);
  if (!(textCtl in lineCounts) || !textCtl.val().length){
    lineCounts[textCtl] = 0;
  }
  lineCounts[textCtl] += 1;
  var newVal = textCtl.val() + text + end;
  textCtl.val(newVal);
  var scrollHeight = textCtl[0].scrollHeight
  if (followOutput) {
    textCtl.scrollTop(scrollHeight);
  }
  if (lineCounts[textCtl] > 1000) {
    if (!notifiedLogTruncation) {
      $("#log").val($("#log").val() + "Logged > 1000 lines.  Log will be trimmed down to last 1000 lines.\n");
      notifiedLogTruncation = true;
    }
    newVal = newVal.slice(newVal.indexOf("\n")+1)
    textCtl.val(newVal);
  }
}

function load() {
  swsConnection = SimpleWebSerial.setupSerialConnection({
      requestElement: "connect",
      baudRate: 115200,
  });
  swsConnection.on('log', function(data) {
    add_text("output", data);
  });
  const showdebugger = localStorage.getItem("showdebugger");
  const showheader = localStorage.getItem("showheader");
  const showdecompile = localStorage.getItem("showdecompile");
  if (showdebugger == "true") {
    $("#debugger").show();
    $("#debuggerButton").text("Hide Debugger");
  }
  if (showheader == "true") {
    click_header();
  }
  if (showdecompile == "true") {
    $("#decomp_div").show();
    $("#decompile_check").prop("checked", true);
  }
}


// Request access to a serial port
async function toggleSerial() {
  try {
    $("#connect").html("Connected");
    $("#connect").prop("disabled",true);
    add_text("log","Started Device Connection");
  } catch (error) {
    console.error("Serial connection error:", error);
    add_text("log", "Failed to Connect to Device: "+error);
  }
}

clock_running = false

function toggleClock() {
  if (!swsConnection.ready()) {
    alert("You must connect to a device before sending commands.");
    return;
  }

  hz = Number($("#hz").val());
  if (Number.isNaN(hz)) {
    alert("The clock interval must be a whole or decimal number (double).");
    return;
  }
  if (clock_running) {
    swsConnection.send("debugger",{
      action: "stop",
    });
    $("#start").html("Start Clock");
  }
  else {
    swsConnection.send("debugger",{
      action: "start",
      hz: hz
    });
    $("#start").html("Stop Clock");      
  }
  add_text("log", (clock_running?"Stopping":"Starting") +" Clock");
  clock_running = !clock_running;
}

function pulse() {
  if (!swsConnection.ready()) {
    alert("You must connect to a device before sending commands.");
    return;
  }
  swsConnection.send("debugger", {action: "pulse"});
  add_text("log","Pulsed clock");
}

function updateFollowOutput() {
  followOutput = $("#follow").val();
}

function updateShowDecompiler() {
  $("#decomp_div").toggle();
  localStorage.setItem("showdecompile", !$("#decomp_div").is(":hidden"));
}

function toggleDebuggerView() {
  const debuggerView = $("#debugger");
  var show = null;
  if (debuggerView.is(":hidden")) {
    $("#debugger").show();
    $("#debuggerButton").text("Hide Debugger");
    show = true;
  }
  else {
    $("#debugger").hide();
    $("#debuggerButton").text("Show Debugger");
    show = false;
  }
  localStorage.setItem("showdebugger", show);
}

function toggleLogging() {
  if (!swsConnection.ready()) {
    alert("You must connect to a device before sending commands.");
    return;
  }

  var dl_check = $("#disable_logging").is(":checked");
  swsConnection.send("debugger",{
    action: "set_logging",
    disabled: dl_check
  });
  add_text("log","Set logging disabled to: "+dl_check);
}

function click_header() {
  $("#header_div").toggle();
  const debuggerView = $("#header_div");

  localStorage.setItem("showheader", debuggerView.is(":hidden"));
}

function get_instrs(txt) {
  try {
    lines = txt.split("\n");
    instrs = [];
    for (index in lines) {
      line = lines[index];
      if (line.length == 0){
        continue;
      }
      toks = line.split(/\s+/);
      instr = {
        addr_b: toks[0],
        data_b: toks[1],
        addr: toks[2],
        data: toks[3],
        rw: toks[4],
        reset: toks[5]
      }
      instrs.push(instr);
    }
  }
  catch (error ){
    return [{error:"Failed to parse.",
            details: error}]
  }  
  return instrs;
}

function get_wrong_lines(addr) {
  var actual = parseInt(addr,16);
  var expected = parseInt("fffc",16);
  var expected_bits = [];
  var actual_bits = [];
  for (i=0;i<16;i++) {
    expected_bits.unshift(expected&1);
    expected = expected >> 1;
    actual_bits.unshift(actual&1);
    actual = actual >> 1;
  }
  var incorrect_bits = [];
  for (i=0;i<16;i++) {
    if (actual_bits[i] != expected_bits[i]) {
      incorrect_bits.push(actual_bits[i]);
    }
    else {
      incorrect_bits.push("_");
    }
  }
  return "Expected Bits: "+expected_bits.join("")+"\n"+
         "Actual Bits  : "+actual_bits.join("")+"\n"+
         "Errors       : "+incorrect_bits.join("");
}

function diagnose_missing_reset_vector(instrs) {
  var resetting = false;
  var reset_phase = 0;
  for (index in instrs){
    if (instrs[index].reset == 'R') {
      resetting = true;
      continue;
    }
    else {
      if (reset_phase == 7) {
         //We expect addr 0xfffc here.  If we don't get it, perhaps it is a wiring issue.
         if (instrs[index].addr == 'fffc') {
           return "This is surprising. We see 0xfffc in the right spot.  But the reason we got here was this was missing. Maybe this is a bug in the tools?";
         }
         return "We expected fffc 7 cycles after the Reset button was released.\n"+
                   "However, we saw: "+ instrs[index].addr +".  Details:\n"+
                   get_wrong_lines(instrs[index].addr);
      }
      if (resetting) {
        reset_phase += 1;
      }      
    }
  }
  if (!resetting) {
    return "No reset signal was detected.  Be sure:\n"+
     "A.  You are holding down the reset button for at least 3 clock cycles.\n" +
     "B.  Pin 25 on the Arduino is connected to a common terminal to the 6502 Reset Pin #40.\n"+
     "C.  Double check the reset button wiring.  Common problems include:\n"+
     "   i.   Incorrect wiring.\n"+
     "   ii.  A rotated 4 post reset switch.  Try rotating it 90 degrees.\n"+
     "   iii. Be sure the resistor has not come lose or gone missing.\n";
  }  
}

function parse(txt) {
  start = -1;
  instrs = get_instrs(txt);
  if ("error" in instrs[0]) {
    return instrs[0];
  }
  for (index in instrs){
    if (instrs[index].addr == 'fffc') {
      start = index;
      break;
    }
  }
  if (start == -1) {
    help = diagnose_missing_reset_vector(instrs);
    return [{error:"Reset vector address 0xfffc not found.",
            details: help}];
  }
  instrs = instrs.slice(index)
  return instrs;
}


function print_default(log, cycle, instruction) {
  var out = "";
  if (instruction.bytes > 1 ){
    for (var i=1;i<instruction.bytes;i++) {
      out += `${log[cycle+i].data},`;       
    }
  }
  return out;
}


function print_addr(log, cycle, instruction) {
  return `Address = 0x${log[cycle+2].data}${log[cycle+1].data}, `;
}

function print_lda(log, cycle, instruction) {
  var decoded = h_to_c_b(log[cycle+1].data);
  return `data=${log[cycle+1].data} (c='${decoded[0]}',b=${decoded[1]}), `;
}

function print_jsr(log, cycle, instruction) {
  return `Address = 0x${log[cycle+2].data}${log[cycle+1].data}, `;
}

function instr_info(opcode, code, name, bytes, cycles, format=print_default) {
  return {opcode:opcode, code:code, name:name, bytes:bytes, cycles:cycles, format:format};
}

instr_table = {
  0xea: instr_info("ea", "NOP", "No Op",                      1, 2),
  0xa9: instr_info("a9", "LDA", "Load Accum",                 2, 2, print_lda),
  0x8d: instr_info("8d", "STA", "Store Accum In Memory",      3, 4, print_addr),
  0x6a: instr_info("6a", "ROR", "Rotate Right",               1, 2),
  0x4c: instr_info("4c", "JMP", "Jump",                       3, 3, print_addr),
  0x9a: instr_info("9a", "TXS", "Transfer Index A to Stack",  1, 2),
  0xa2: instr_info("a2", "LDX", "Load Index X with Memory",   2, 2),
  0x20: instr_info("20", "JSR", "Jump to Subroutine",         3, 6, print_addr),
  0x60: instr_info("60", "RTS", "Return from Subroutine",     1, 6),
  0x48: instr_info("48", "PHA", "Push Accum to Stack",        1, 3),
  0xad: instr_info("ad", "LDA", "Load Accum from Absolute",   3, 4, print_addr),
  0x29: instr_info("29", "AND", "AND Memory w/ Accum Immed.", 2, 2),
  0x68: instr_info("68", "PLA", "Pull Accum from Stack",      1, 4),
  0xd0: instr_info("d0", "BNE", "Branch on Result not Zero",  2, 2),
}

function lookup_instruction(opcode) {
  if (typeof opcode == "string") {
    opcode = parseInt(opcode,"16");
  }
  if (opcode in instr_table) {
    return instr_table[opcode];
  }
  return instr_info("parse_error", "", "", 0, 0);
}

function h_to_c_b(hex_str) {
  var v = parseInt(hex_str, 16);
  return [String.fromCharCode(v), v.toString(2)];
}

function print_log(log) {
  var output = "Address, Opcode, Info\n"+
               "---------------------\n";

  var instrs_count = log.length;
  output += `fffc, ${log[0].data}, Load Start Address High Byte\n`;
  output += `fffd, ${log[1].data}, Load Start Address Low Byte\n`;

  for(var cycle=2; cycle<instrs_count-2; cycle++) {
    var instr_line = log[cycle]
    try {
      instruction = lookup_instruction(instr_line.data)
      output += `${instr_line.addr}, ${instr_line.data}, ${instruction.code}: `;
      output += instruction.format(log, cycle, instruction);  
      if (instruction.cycles > 1) {
        cycle += instruction.cycles-1;
      }
    }
    catch(error) {
      output += `error:${error}`;
    }
    output += '\n';
  }
  return output;
}

function decompile() {
  var txt = $("#output").val();
  log = parse(txt);
  if ("error" in log[0]) {
    $("#decomp_text").val(log[0].error+'\n'+log[0].details);
  }
  else{
    $("#decomp_text").val(print_log(log));    
  }
}

</script>

<body onload="load()">
  <div style="width: 100%; overflow: hidden;">
    <button id='connect' onclick="toggleSerial()">Connect Serial</button>
    <br>
    <div style="width: 100%; overflow: hidden;">
      <div style="float: left;">
        <button id='start' onclick="toggleClock()">Start Clock</button>
        <input type="text" size="1" value="10" id="hz"></input> Hz
      </div>
    </div>
    <div>
      <button id='pulse' onclick="pulse()">Pulse Clock</button>
    </div>
    <div>
      <input type="checkbox" id="disable_logging" onclick="toggleLogging()"></input>
      <label for="disable_logging" title="You can disable logging to increase clock speed.">Disable Logging</label>
      <input type="checkbox" id="follow" onclick="updateFollowOutput()" checked></input>
      <label for="follow" title="Scroll to Follow the Output.">Follow</label>
      <input type="checkbox" id="decompile_check" onclick="updateShowDecompiler()"></input>      
      <label for="decompile_check" title="Show Decompiler Tool.">Show Decompiler</label>
    </div>
    <br>
    <div id="debugger" style="display:none;">
      <div style="width: 100%; overflow: hidden;">
        <div style="float: left; vertical-align: bottom;">
          <span style="font-size: 20px; font-weight:bold">Device Output</span>
        </div>
        <br>
        <br>
        <div>
          <div>
            <table onclick="click_header()" title="Click to show/hide.">
              <tr align="left">
                <th width="135">Address(B)</th>
                <th width="75">Data(B)</th>
                <th width="75">Addr(H)</th>
                <th width="100">Data(H)</th>
                <th width="100">Read/Write</th>
                <th width="100">Reset</th>
              </tr>
            </table>
            <div id='header_div' onclick="click_header()" title="Click to Hide/Show">
              <pre style="margin:0">     |               |          |         |              |              |</pre>
              <pre style="margin:0">     |               |          |   |------              |              |</pre>
              <pre style="margin:0">     |               |          |   |  |-----------------               |</pre>
              <pre style="margin:0">     |               |          |   |  |  |------------------------------</pre>
            </div>
          </div>
        </div>
        <div style="float: left;">
          <textarea style="width: 600;height: 400" id='output' rows="30" spellcheck="false" autocapitalize="off" autocorrect="off" autocomplete="off"></textarea>
        </div>
        <div id="decomp_div" style="margin-top:-20" hidden>
          <button id="decomp_button" style="display:block" onclick="decompile()">Decompile</button>
          <textarea id='decomp_text' rows="28" style="width: 600;height: 400;" spellcheck="false" autocapitalize="off" autocorrect="off" autocomplete="off"></textarea> 
        </div>
      </div>
      <br>
      Log<br>
      <textarea id='log' rows="10" style="width: 600;" spellcheck="false" autocapitalize="off" autocorrect="off" autocomplete="off" readonly></textarea>
    </div>
  </div>
  <button onclick="toggleDebuggerView()" id="debuggerButton">Show Debugger</button>
  <br><br>
  For use with <a href="https://the6502.com">the6502.com</a> workshop. 
</body>
</head>
